<div class="flex h-screen flex-col md:flex-row">
  <!-- Left Sidebar: User Search + Conversation List -->
  <!-- Hidden on mobile when conversation is selected, always visible on md+ -->
  <div
    class="border-r border-gray-200 dark:border-gray-700 flex flex-col bg-white dark:bg-gray-900"
    [class.hidden]="currentConversation() !== null"
    [class.w-full]="!currentConversation()"
    [class.md:flex]="true"
    [class.md:w-80]="true"
  >
    <!-- User Search -->
    <app-user-search (userSelected)="onUserSelected($event)" />

    <!-- Conversation List -->
    <app-conversation-list
      [selectedConversationId]="currentConversation()?.id || null"
      (conversationSelected)="onConversationSelected($event)"
    />
  </div>

  <!-- Right Side: Chat Area -->
  <div
    class="flex-1 flex flex-col h-screen"
    [class.hidden]="!currentConversation()"
    [class.md:flex]="true"
  >
    @if (!currentConversation()) {
    <!-- No conversation selected -->
    <div class="hidden md:flex flex-1 items-center justify-center text-gray-500 dark:text-gray-400">
      <div class="text-center">
        <p class="text-lg font-medium">Select a conversation or search for a user</p>
        <p class="text-sm mt-2">Start chatting by selecting a conversation from the list</p>
      </div>
    </div>
    } @else if (chatService.isLoading()) {
    <!-- Loading messages -->
    <div class="flex flex-1 justify-center items-center">
      <ng-icon name="lucideLoader" size="48" class="animate-spin" />
    </div>
    } @else {
    <!-- Chat Header -->
    <div
      class="shrink-0 px-4 md:px-6 py-3 border-b border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-900"
    >
      <div class="flex items-center gap-3">
        <button
          hlmBtn
          variant="ghost"
          size="icon"
          (click)="backToConversations()"
          class="md:hidden"
        >
          <ng-icon name="lucideChevronLeft" size="20" />
        </button>

        <hlm-avatar>
          @if (getAvatarUrl(currentConversation())) {
          <img
            [src]="getAvatarUrl(currentConversation())"
            hlmAvatarImage
            [alt]="getOtherParticipant(currentConversation())?.username || 'User'"
          />
          }
          <span class="text-white bg-destructive" hlmAvatarFallback>
            {{
              (getOtherParticipant(currentConversation())?.username || 'U').charAt(0).toUpperCase()
            }}
          </span>
        </hlm-avatar>
        <div class="flex-1 min-w-0">
          <h2 class="font-semibold text-gray-900 dark:text-gray-100 truncate">
            {{
              getOtherParticipant(currentConversation())?.username ||
                getOtherParticipant(currentConversation())?.email
            }}
          </h2>
        </div>
        
        <!-- Menu Button -->
        <div class="relative">
          <button
            hlmBtn
            variant="ghost"
            size="icon"
            (click)="toggleMenu()"
            title="More options"
          >
            <ng-icon name="lucideMoreVertical" size="20" />
          </button>
          
          <!-- Menu Dropdown -->
          @if (showMenu()) {
          <div
            class="absolute right-0 top-full mt-1 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-md shadow-lg z-50"
          >
            <button
              (click)="removeFriendInConversation()"
              class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 first:rounded-t-md flex items-center gap-2 text-yellow-600 dark:text-yellow-400"
            >
              <ng-icon name="lucideUserMinus" size="16" />
              <span>Remove Friend</span>
            </button>
            <button
              (click)="blockUserInConversation()"
              class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 last:rounded-b-md flex items-center gap-2 text-red-600 dark:text-red-400"
            >
              <ng-icon name="lucideShield" size="16" />
              <span>Block User</span>
            </button>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Messages Area - Takes remaining space -->
    <div #messagesContainer class="flex-1 overflow-y-auto bg-white dark:bg-gray-900 px-3 pt-2 pb-40">
      @for (msg of chatService.messages(); track msg.id) {
      <app-message-body [message]="msg" />
      }
    </div>
    }
  </div>

  <!-- New Message Input - Fixed at bottom, outside grid -->
  @if (currentConversation()) {
  <div
    class="fixed bottom-0 left-0 right-0 md:left-80 bg-white dark:bg-gray-900 border-t border-gray-200 dark:border-gray-700 z-10 px-3"
  >
    <app-new-message [conversationId]="currentConversation()!.id" />
  </div>
  }
</div>

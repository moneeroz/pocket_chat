<div [class]="containerClass()">
  <div [class]="contentWrapperClass()">
    <div [class]="headerClass()">
      <div [class]="messageClass()">
        <!-- File Content -->
        @if (isFileMessage()) {
        <div class="mb-1 relative">
          <!-- File Menu Button (visible to all users, but positioned based on sender) -->
          <div class="absolute -top-2 -right-2 z-20">
            <button
              (click)="toggleFileMenu($event)"
              class="p-1.5 bg-gray-700 dark:bg-gray-600 hover:bg-gray-800 dark:hover:bg-gray-500 text-white rounded-full shadow-lg transition-all opacity-100 md:opacity-0 md:group-hover:opacity-100"
              title="File options"
            >
              <ng-icon name="lucideMoreVertical" size="16" />
            </button>

            <!-- Dropdown Menu -->
            @if (showFileMenu()) {
            <div class="fixed inset-0 z-30" (click)="closeFileMenu()"></div>
            <div class="absolute right-0 top-full mt-1 w-40 bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 py-1 z-40 animate-in fade-in slide-in-from-top-2 duration-200">
              <!-- Download (visible to all users) -->
              <button
                (click)="downloadFile()"
                class="w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2 transition-colors"
              >
                <ng-icon name="lucideDownload" size="16" />
                <span>Download</span>
              </button>

              <!-- Delete (only for sender) -->
              @if (isCurrentUser()) {
              <hlm-alert-dialog>
                <button
                  brnAlertDialogTrigger
                  class="w-full text-left px-4 py-2 text-sm text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20 flex items-center gap-2 transition-colors rounded-none"
                >
                  <ng-icon name="lucideTrash2" size="16" />
                  <span>Delete</span>
                </button>
                <hlm-alert-dialog-content *brnAlertDialogContent="let ctx">
                  <hlm-alert-dialog-header>
                    <h2 hlmAlertDialogTitle>Delete Message</h2>
                    <p hlmAlertDialogDescription>
                      Are you sure you want to delete this message? This action cannot be undone.
                    </p>
                  </hlm-alert-dialog-header>
                  <hlm-alert-dialog-footer>
                    <button hlmAlertDialogCancel (click)="ctx.close()">Cancel</button>
                    <button hlmAlertDialogAction (click)="deleteFile(); ctx.close()">Delete</button>
                  </hlm-alert-dialog-footer>
                </hlm-alert-dialog-content>
              </hlm-alert-dialog>
              }
            </div>
            }
          </div> @switch (message().fileType) {
          <!-- Image Message -->
          @case ('image') {
          <div class="max-w-[250px] md:max-w-xs rounded-lg overflow-hidden aspect-video bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
            <img
              [src]="fileUrl()"
              [alt]="message().fileName || 'Image'"
              class="max-w-full max-h-full cursor-pointer hover:opacity-90 transition-opacity"
              (click)="downloadFile()"
            />
          </div>
          }

          <!-- Video Message -->
          @case ('video') {
          <div class="max-w-[250px] md:max-w-xs rounded-lg overflow-hidden aspect-video">
            <video [src]="fileUrl()" controls class="w-full h-full" preload="metadata">
              Your browser does not support the video tag.
            </video>
          </div>
          }

          <!-- Audio Message -->
          @case ('audio') {
          <div class="w-full min-w-[200px] max-w-[250px] md:max-w-xs">
            <audio [src]="fileUrl()" controls class="w-full" preload="metadata">
              Your browser does not support the audio tag.
            </audio>
          </div>
          }

          <!-- Document Message -->
          @case ('document') {
          <div
            class="flex items-center gap-3 p-3 rounded-lg bg-gray-100 dark:bg-gray-800"
          >
            <div class="shrink-0">
              <ng-icon [name]="fileIcon()" class="text-blue-600 dark:text-blue-400" size="32" />
            </div>
            <div class="flex-1 min-w-0">
              <div class="text-xs md:text-sm font-medium text-gray-900 dark:text-gray-100 truncate">
                {{ message().fileName }}
              </div>
              <div class="text-[10px] md:text-xs text-gray-500 dark:text-gray-400">
                {{ formatFileSize(message().fileSize || 0) }}
              </div>
            </div>
          </div>
          } }

          <!-- File caption (text) if provided -->
          @if (message().text) {
          <div class="mt-2 text-xs md:text-sm">
            {{ message().text }}
          </div>
          }
        </div>
        }

        <!-- Text-only Message -->
        @if (!isFileMessage() && message().text) {
        <p class="text-sm md:text-base">{{ message().text }}</p>
        }
      </div>
    </div>
    <span class="text-[11px] text-gray-700 dark:text-gray-300 text-end pt-1">
      {{ formattedTime() }}
    </span>
  </div>
</div>
